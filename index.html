<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QR Attendance</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #0b1220; color: white; text-align: center; }
    #reader { width: 350px; margin: auto; }
    button { margin: 10px; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
    .good { background: #39d353; color: black; }
    .warn { background: #f0b429; }
    .bad { background: #ff6b6b; }
  </style>
</head>
<body>
  <h2>üì∑ QR Attendance Scanner</h2>
  <div id="reader"></div>
  <div>
    <button onclick="startScanner()">Start Scanner</button>
    <button onclick="stopScanner()">Stop Scanner</button>
    <button onclick="flipCamera()">Flip Camera</button>
    <button onclick="showScanned()">Show Scanned</button>
    <button onclick="showPending()">Show Pending</button>
  </div>
  <pre id="output"></pre>

  <script>
    const SCRIPT_URL = "YOUR_SCRIPT_LINK_HERE"; // replace with your Apps Script WebApp link
    let html5QrCode;
    let currentCameraId = null;
    let useBackCamera = true;
    let masterlist = {};
    let scanned = new Set();

    // Load masterlist from Google Sheets
    async function loadMasterlist() {
      const res = await fetch(SCRIPT_URL);
      masterlist = await res.json();
      console.log("‚úÖ Loaded master list:", masterlist);
    }

    // Start scanner
    async function startScanner() {
      if (html5QrCode) await html5QrCode.stop();
      html5QrCode = new Html5Qrcode("reader");

      const devices = await Html5Qrcode.getCameras();
      if (devices && devices.length) {
        currentCameraId = useBackCamera && devices[1] ? devices[1].id : devices[0].id;
        html5QrCode.start(
          currentCameraId,
          { fps: 10, qrbox: 250 },
          qrCodeMessage => handleScan(qrCodeMessage),
          errorMessage => {}
        );
      }
    }

    // Stop scanner
    async function stopScanner() {
      if (html5QrCode) {
        await html5QrCode.stop();
        document.getElementById("output").textContent += "\n‚èπÔ∏è Scanner stopped";
      }
    }

    // Flip camera
    function flipCamera() {
      useBackCamera = !useBackCamera;
      startScanner();
    }

    // Handle scanned QR
    async function handleScan(id) {
      if (scanned.has(id)) return; // Already scanned
      scanned.add(id);

      if (masterlist[id]) {
        document.getElementById("output").textContent = `‚úÖ ${id} - ${masterlist[id].NAME} marked present`;
        // Update Google Sheet
        fetch(SCRIPT_URL, {
          method: "POST",
          body: new URLSearchParams({ id: id })
        });
      } else {
        document.getElementById("output").textContent = `‚ùå ID ${id} not in masterlist`;
      }
    }

    // Show scanned IDs
    function showScanned() {
      document.getElementById("output").textContent = "‚úÖ Scanned:\n" + [...scanned].join("\n");
    }

    // Show pending IDs
    function showPending() {
      const pending = Object.keys(masterlist).filter(id => !scanned.has(id));
      document.getElementById("output").textContent = "‚è≥ Pending:\n" + pending.join("\n");
    }

    // Load masterlist at startup
    loadMasterlist();
  </script>
</body>
</html>

