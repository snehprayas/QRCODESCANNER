<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QR Code Scanner</title>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #reader { width: 320px; height: 320px; margin-bottom: 10px; }
    button { margin: 5px; padding: 10px; }
    #output { margin-top: 20px; font-weight: bold; }
  </style>
</head>
<body>
  <h1>QR Code Scanner</h1>

  <div id="reader"></div>
  <button onclick="startScanner()">Start Scanner</button>
  <button onclick="showScanned()">Show Scanned</button>
  <button onclick="showPending()">Show Pending</button>
  <button onclick="resetData()">Reset</button>

  <div id="output"></div>

  <script type="module">
    // ---------------- FIREBASE ----------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getDatabase, ref, set, get, child, remove } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDnlTfbTFtFZzAEXNHaq2UqVLdTYVfrbW4",
      authDomain: "qr-attendance-79e24.firebaseapp.com",
      projectId: "qr-attendance-79e24",
      storageBucket: "qr-attendance-79e24.firebasestorage.app",
      messagingSenderId: "255067675399",
      appId: "1:255067675399:web:501f5b0348a38999ed03a2",
      measurementId: "G-3B1Q8B6DDD",
      databaseURL: "https://qr-attendance-79e24-default-rtdb.asia-southeast1.firebasedatabase.app/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ---------------- MASTER LIST ----------------
    let masterList = [];

    fetch("masterlist.csv")
      .then(response => response.text())
      .then(csvText => {
        Papa.parse(csvText, {
          header: true,
          complete: function(results) {
            masterList = results.data.map(row => ({
              ID: row["Row Label"] ? row["Row Label"].trim() : "",
              Name: row["NAME"] ? row["NAME"].trim() : ""
            })).filter(p => p.ID !== "");
            console.log("✅ Loaded master list:", masterList);
          }
        });
      });

    // ---------------- QR SCANNER ----------------
    let html5QrcodeScanner;

    function startScanner() {
      const qrCodeSuccessCallback = (decodedText, decodedResult) => {
        markScanned(decodedText);
      };

      html5QrcodeScanner = new Html5Qrcode("reader");
      Html5Qrcode.getCameras().then(devices => {
        if (devices && devices.length) {
          // Rear camera = last one
          const cameraId = devices[devices.length - 1].id;
          html5QrcodeScanner.start(
            cameraId,
            { fps: 10, qrbox: 250 },
            qrCodeSuccessCallback
          );
        }
      });
    }

    // ---------------- MARK SCANNED ----------------
    function markScanned(qrValue) {
      // If QR is a link, take the last part after "/"
      let id = qrValue.includes("/") ? qrValue.split("/").pop().trim() : qrValue.trim();

      const person = masterList.find(p => p.ID === id);
      if (!person) {
        alert("⚠️ ID not in master list: " + id);
        return;
      }

      set(ref(db, "scanned/" + id), {
        ID: person.ID,
        Name: person.Name,
        time: new Date().toLocaleString()
      });

      document.getElementById("output").innerText =
        "✅ Scanned: " + person.ID + " - " + person.Name;
    }

    // ---------------- SHOW SCANNED ----------------
    function showScanned() {
      get(child(ref(db), "scanned")).then(snapshot => {
        if (snapshot.exists()) {
          let data = snapshot.val();
          let list = Object.values(data)
            .map(p => p.ID + " - " + p.Name + " (" + p.time + ")")
            .join("<br>");
          document.getElementById("output").innerHTML = "<h3>Scanned:</h3>" + list;
        } else {
          document.getElementById("output").innerText = "No scans yet.";
        }
      });
    }

    // ---------------- SHOW PENDING ----------------
    function showPending() {
      get(child(ref(db), "scanned")).then(snapshot => {
        let scannedIDs = snapshot.exists() ? Object.keys(snapshot.val()) : [];
        let pending = masterList.filter(p => !scannedIDs.includes(p.ID));
        let list = pending.map(p => p.ID + " - " + p.Name).join("<br>");
        document.getElementById("output").innerHTML = "<h3>Pending:</h3>" + list;
      });
    }

    // ---------------- RESET ----------------
    function resetData() {
      if (confirm("Are you sure you want to clear all data?")) {
        remove(ref(db, "scanned"));
        document.getElementById("output").innerText = "All scan data cleared.";
      }
    }
  </script>
</body>
</html>
