<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QR Attendance</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 20px;
    }
    #reader {
      width: 300px;
      margin: auto;
    }
    #controls {
      margin-top: 15px;
    }
    button {
      margin: 5px;
      padding: 10px 15px;
      font-size: 14px;
    }
    #output {
      margin-top: 20px;
      text-align: left;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 5px;
      background: #f9f9f9;
    }
  </style>

  <!-- ‚úÖ Load QR Scanner library -->
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
</head>
<body>
  <h2>üì∑ QR Attendance System</h2>

  <div id="reader"></div>

  <div id="controls">
    <button onclick="startScanner()">Start Scanner</button>
    <button onclick="stopScanner()">Stop Scanner</button>
    <button onclick="showScanned()">Show Scanned</button>
    <button onclick="showPending()">Show Pending</button>
    <button onclick="resetData()">Reset</button>
  </div>

  <div id="output"><b>Status:</b> Waiting...</div>

  <script>
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbymlcxV4iO-e0aQyG35tYSqWkp4sED-OTms6u1gHX7YIaKAmMOVIWu3QZdC9Bo3yu4/exec"; 
    let masterList = {};
    let scanned = [];
    let html5QrCode;

    // ‚úÖ Load master list from Google Sheets
    async function loadMasterList() {
      try {
        const res = await fetch(SHEET_URL);
        masterList = await res.json();
        console.log("‚úÖ Loaded master list:", masterList);
        document.getElementById("output").innerHTML = "‚úÖ Master list loaded. Ready to scan.";
      } catch (e) {
        console.error("‚ùå Error loading master list:", e);
        document.getElementById("output").innerHTML = "‚ùå Failed to load master list.";
      }
    }

    // ‚úÖ Start QR scanner
    function startScanner() {
      html5QrCode = new Html5Qrcode("reader");
      Html5Qrcode.getCameras().then(devices => {
        if (devices && devices.length) {
          // Prefer rear camera if available
          const cameraId = devices.length > 1 ? devices[1].id : devices[0].id;
          html5QrCode.start(
            cameraId,
            { fps: 10, qrbox: 250 },
            qrCodeMessage => handleScan(qrCodeMessage)
          ).catch(err => console.error("‚ùå Start failed:", err));
        }
      }).catch(err => console.error("‚ùå Camera error:", err));
    }

    // ‚úÖ Stop QR scanner
    function stopScanner() {
      if (html5QrCode) {
        html5QrCode.stop().then(() => {
          console.log("Scanner stopped");
        }).catch(err => console.error("‚ùå Stop failed:", err));
      }
    }

    // ‚úÖ Handle scan result
    function handleScan(id) {
      id = id.trim();
      if (!masterList[id]) {
        document.getElementById("output").innerHTML = "‚ùå ID not in master list: " + id;
        return;
      }
      if (!scanned.includes(id)) scanned.push(id);
      const data = masterList[id];
      document.getElementById("output").innerHTML =
        `<b>Scanned:</b> ${id}<br>
         Name: ${data.NAME}<br>
         Contact: ${data.CONTACT}<br>
         Age: ${data.AGE}<br>
         Gender: ${data.GENDER}<br>
         Size: ${data.SIZE}<br>
         Paid: ${data.Paid}<br>
         Due: ${data.Due}<br>
         Total: ${data.Total}<br>
         Confirmation: ${data.Confirmation}`;
    }

    // ‚úÖ Show scanned list
    function showScanned() {
      document.getElementById("output").innerHTML =
        "<b>Scanned IDs:</b><br>" + scanned.join("<br>");
    }

    // ‚úÖ Show pending list
    function showPending() {
      const pending = Object.keys(masterList).filter(id => !scanned.includes(id));
      document.getElementById("output").innerHTML =
        "<b>Pending IDs:</b><br>" + pending.join("<br>");
    }

    // ‚úÖ Reset scanned data
    function resetData() {
      scanned = [];
      localStorage.removeItem("scanned");
      document.getElementById("output").innerHTML = "‚úÖ Data reset.";
    }

    // ‚úÖ Restore from localStorage
    window.onload = () => {
      scanned = JSON.parse(localStorage.getItem("scanned")) || [];
      loadMasterList();
    };

    // ‚úÖ Save scanned list persistently
    window.onbeforeunload = () => {
      localStorage.setItem("scanned", JSON.stringify(scanned));
    };
  </script>
</body>
</html>
