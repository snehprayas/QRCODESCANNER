<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>QR Attendance Shared</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0b1220; --card: #121a2a; --accent: #4cc9f0;
      --good: #39d353; --warn: #f0b429; --bad: #ff6b6b;
    }
    body {
      margin: 0; font-family: system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background: var(--bg); color: #fff;
    }
    .container { padding: 16px; max-width: 900px; margin: auto; }
    h1 { margin: 0 0 16px; font-size: 24px; }
    .controls { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
    button {
      padding: 10px 14px; border: none; cursor: pointer;
      border-radius: 6px; font-weight: 600;
    }
    .good { background: var(--good); color: #000; }
    .warn { background: var(--warn); color: #000; }
    .bad { background: var(--bad); color: #000; }
    #reader { width: 100%; max-width: 480px; margin: auto; border: 1px solid #333; padding: 8px; }
    #log, .list { background: var(--card); padding: 12px; border-radius: 8px; margin-top: 16px; }
    .list { max-height: 200px; overflow-y: auto; font-family: monospace; white-space: pre-wrap; }
  </style>
</head>
<body>
  <div class="container">
    <h1>QR Attendance (Shared)</h1>
    <div class="controls">
      <button onclick="startScanner()">Start</button>
      <button onclick="stopScanner()">Stop</button>
      <button onclick="flipCamera()">Flip Cam</button>
      <button class="good" onclick="showScanned()">Scanned</button>
      <button class="warn" onclick="showPending()">Pending</button>
      <button class="bad" onclick="resetAll()">Reset All</button>
    </div>

    <div id="reader"></div>
    <div id="log">Status: idle</div>

    <div class="list" id="scannedList">Scanned: —</div>
    <div class="list" id="pendingList">Pending: —</div>
  </div>

  <script>
    // Use your provided Apps Script URL here:
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzzROY9RnYuwBDclCyQidTN-jmQegiuZyo9dhsCfbYVGFSUwcdX1qfxmJwjLeLWKQhr/exec";

    let html5QrCode = null;
    let preferBack = true;
    let master = {};
    let sharedScanned = [];

    window.addEventListener("load", async () => {
      await refreshData();
      setInterval(refreshData, 2000);
    });

    async function refreshData() {
      // Load masterlist
      const m = await fetch(SCRIPT_URL).then(r => r.json()).catch(() => ({}));
      if (Object.keys(m).length) master = m;

      // Load shared scanned list
      sharedScanned = await fetch(`${SCRIPT_URL}?scanned=true`)
        .then(r => r.json()).catch(() => sharedScanned);

      updateLists();
    }

    function updateLists() {
      document.getElementById("scannedList").textContent =
        "Scanned:\n" + (sharedScanned.join("\n") || "—");

      const pending = Object.keys(master).filter(id => !sharedScanned.includes(id));
      document.getElementById("pendingList").textContent =
        "Pending:\n" + (pending.join("\n") || "—");
    }

    function setLog(msg) {
      document.getElementById("log").textContent = msg;
    }

    async function startScanner() {
      try {
        if (html5QrCode) await html5QrCode.stop();
        html5QrCode = new Html5Qrcode("reader");
        const cams = await Html5Qrcode.getCameras();
        if (!cams || !cams.length) {
          alert("No camera detected!");
          return;
        }
        const camId = (preferBack && cams.length > 1) ? cams[cams.length - 1].id : cams[0].id;
        await html5QrCode.start(camId, { fps: 10, qrbox: 250 }, onScanSuccess, _ => {});
        setLog("Scanning...");
      } catch (err) {
        console.error(err);
        setLog("Error starting scanner");
      }
    }

    async function stopScanner() {
      if (html5QrCode) {
        await html5QrCode.stop();
        setLog("Scanner stopped");
      }
    }

    async function flipCamera() {
      preferBack = !preferBack;
      await stopScanner();
      await startScanner();
    }

    async function onScanSuccess(decodedText) {
      const id = decodedText.trim();
      if (!master[id]) {
        setLog(`❌ Not in masterlist: ${id}`);
        return;
      }
      setLog(`Scanned: ${id} (${master[id].NAME || ""})`);

      await fetch(`${SCRIPT_URL}?action=scan&id=${encodeURIComponent(id)}`)
        .then(r => r.json()).catch(() => null);
      await refreshData();
    }

    async function showScanned() {
      await refreshData();
      alert("Scanned:\n" + (sharedScanned.join(", ") || "None"));
    }

    async function showPending() {
      await refreshData();
      const pending = Object.keys(master).filter(id => !sharedScanned.includes(id));
      alert("Pending:\n" + (pending.join(", ") || "None"));
    }

    async function resetAll() {
      if (!confirm("Clear all scanned marks for everyone?")) return;
      await fetch(`${SCRIPT_URL}?action=reset`).then(r => r.json()).catch(() => null);
      await refreshData();
      setLog("All cleared");
    }
  </script>
</body>
</html>
