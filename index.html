<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>QR Attendance</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg: #0b1220;
      --card: #121a2a;
      --muted: #9fb0d3;
      --accent: #4cc9f0;
      --good: #39d353;
      --warn: #f0b429;
      --bad: #ff6b6b;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% -10%, #1a2750 0%, transparent 70%),
                  radial-gradient(900px 900px at 100% 0%, rgba(76,201,240,0.15) 0%, transparent 60%),
                  var(--bg);
      color: white;
    }
    #reader { width: 100%; max-width: 400px; margin: 20px auto; }
    #controls { margin: 20px; text-align: center; }
    button {
      background: var(--accent);
      border: none;
      color: white;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
    }
    #output { margin: 20px; padding: 10px; background: var(--card); border-radius: 10px; }
  </style>

  <!-- ‚úÖ Load QR scanner library before our own JS -->
  <script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>
</head>
<body>
  <h2 style="text-align:center;">üì∑ QR Attendance System</h2>

  <div id="reader"></div>

  <div id="controls">
    <button onclick="startScanner()">Start Scanner</button>
    <button onclick="stopScanner()">Stop Scanner</button>
    <button onclick="showScanned()">Show Scanned</button>
    <button onclick="showPending()">Show Pending</button>
    <button onclick="resetData()">Reset</button>
  </div>

  <div id="output"><b>Status:</b> Waiting...</div>

  <!-- ‚úÖ Our custom JS at the very end -->
  <script>
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbymlcxV4iO-e0aQyG35tYSqWkp4sED-OTms6u1gHX7YIaKAmMOVIWu3QZdC9Bo3yu4/exec";

    let html5QrCode;
    let masterList = {};
    let scannedIDs = JSON.parse(localStorage.getItem("scannedIDs") || "[]");

    // Load master list from Google Sheets
    fetch(SHEET_URL)
      .then(res => res.json())
      .then(data => {
        masterList = data;
        console.log("‚úÖ Master list loaded:", masterList);
      })
      .catch(err => console.error("‚ùå Error loading sheet:", err));

    function startScanner() {
      if (!Html5Qrcode) {
        alert("Scanner library failed to load. Check html5-qrcode script.");
        return;
      }

      html5QrCode = new Html5Qrcode("reader");
      Html5Qrcode.getCameras().then(devices => {
        if (devices.length) {
          let camId = devices.length > 1 ? devices[1].id : devices[0].id;
          html5QrCode.start(
            camId,
            { fps: 10, qrbox: 250 },
            onScanSuccess
          );
          document.getElementById("output").innerHTML = "<b>Status:</b> Scanner started ‚úÖ";
        }
      }).catch(err => {
        console.error("Camera error:", err);
        document.getElementById("output").innerHTML = "‚ùå Unable to access camera";
      });
    }

    function stopScanner() {
      if (html5QrCode) {
        html5QrCode.stop().then(() => {
          html5QrCode.clear();
          document.getElementById("output").innerHTML = "<b>Status:</b> Scanner stopped ‚õî";
        });
      }
    }

    function onScanSuccess(decodedText) {
      if (scannedIDs.includes(decodedText)) {
        document.getElementById("output").innerHTML =
          `‚ö†Ô∏è Already scanned: ${decodedText}`;
        return;
      }

      scannedIDs.push(decodedText);
      localStorage.setItem("scannedIDs", JSON.stringify(scannedIDs));

      if (masterList[decodedText]) {
        let person = masterList[decodedText];
        document.getElementById("output").innerHTML =
          `‚úÖ Scanned: <b>${decodedText}</b><br>
           Name: ${person.NAME}<br>
           Contact: ${person.CONTACT}<br>
           Age: ${person.AGE}<br>
           Gender: ${person.GENDER}<br>
           Size: ${person.SIZE}`;
      } else {
        document.getElementById("output").innerHTML =
          `‚ùå ID not in masterlist: ${decodedText}`;
      }
    }

    function showScanned() {
      document.getElementById("output").innerHTML =
        "<b>Scanned IDs:</b><br>" + scannedIDs.join("<br>");
    }

    function showPending() {
      let pending = Object.keys(masterList).filter(id => !scannedIDs.includes(id));
      document.getElementById("output").innerHTML =
        "<b>Pending IDs:</b><br>" + pending.join("<br>");
    }

    function resetData() {
      scannedIDs = [];
      localStorage.removeItem("scannedIDs");
      document.getElementById("output").innerHTML =
        "<b>Status:</b> Data reset üîÑ";
    }
  </script>
</body>
</html>
