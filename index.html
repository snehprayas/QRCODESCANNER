<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QR Attendance</title>
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; text-align: center; }
    #reader { width: 300px; margin: auto; }
    .btn { padding: 10px 20px; margin: 10px; cursor: pointer; }
    .card { border: 1px solid #ccc; padding: 10px; margin: 10px auto; width: 80%; border-radius: 8px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h2>üì∑ QR Attendance System</h2>

  <div id="reader"></div>

  <button class="btn" onclick="startScanner()">Start Scanner</button>
  <button class="btn" onclick="stopScanner()">Stop Scanner</button>
  <button class="btn" onclick="showScanned()">Show Scanned</button>
  <button class="btn" onclick="showPending()">Show Pending</button>
  <button class="btn" onclick="resetData()">Reset</button>

  <h3 id="status">Loading master list...</h3>
  <div id="result"></div>
  <div id="list"></div>

  <script>
    // üîó Replace with your own Google Apps Script Web App URL
    const API_URL = "https://script.google.com/macros/s/AKfycbymlcxV4iO-e0aQyG35tYSqWkp4sED-OTms6u1gHX7YIaKAmMOVIWu3QZdC9Bo3yu4/exec";

    let masterList = {};
    let scannedIDs = new Set();
    let html5QrCode;

    // Load master list from Google Sheets API
    async function loadMasterList() {
      try {
        const res = await fetch(API_URL);
        masterList = await res.json();
        document.getElementById("status").innerText = `‚úÖ Loaded ${Object.keys(masterList).length} records`;
      } catch (e) {
        document.getElementById("status").innerText = "‚ùå Error loading master list";
        console.error(e);
      }
    }

    function startScanner() {
      if (html5QrCode) return;
      html5QrCode = new Html5Qrcode("reader");
      Html5Qrcode.getCameras().then(devices => {
        if (devices && devices.length) {
          // pick rear camera if available
          let cameraId = devices.length > 1 ? devices[1].id : devices[0].id;
          html5QrCode.start(
            cameraId,
            { fps: 10, qrbox: 250 },
            qrCodeMessage => handleScan(qrCodeMessage)
          );
        }
      }).catch(err => console.error("Camera error", err));
    }

    function stopScanner() {
      if (html5QrCode) {
        html5QrCode.stop().then(() => { html5QrCode = null; });
      }
    }

    function handleScan(id) {
      if (scannedIDs.has(id)) {
        document.getElementById("result").innerHTML = `<p>‚ö†Ô∏è Already scanned: ${id}</p>`;
        return;
      }
      if (masterList[id]) {
        scannedIDs.add(id);
        const person = masterList[id];
        document.getElementById("result").innerHTML = `
          <div class="card">
            <h3>${person.NAME} (${id})</h3>
            <p>üìû ${person.CONTACT}</p>
            <p>üë§ Age: ${person.AGE}, Gender: ${person.GENDER}, Size: ${person.SIZE}</p>
            <p>üí∞ Paid: ${person.Paid}, Due: ${person.Due}, Total: ${person.Total}</p>
            <p>‚úÖ Confirmation: ${person.Confirmation}</p>
          </div>`;
      } else {
        document.getElementById("result").innerHTML = `<p>‚ùå ID not in master list: ${id}</p>`;
      }
    }

    function showScanned() {
      let html = "<h3>‚úÖ Scanned List</h3>";
      scannedIDs.forEach(id => {
        if (masterList[id]) html += `<div class="card">${id} - ${masterList[id].NAME}</div>`;
      });
      document.getElementById("list").innerHTML = html;
    }

    function showPending() {
      let html = "<h3>‚åõ Pending List</h3>";
      Object.keys(masterList).forEach(id => {
        if (!scannedIDs.has(id)) html += `<div class="card">${id} - ${masterList[id].NAME}</div>`;
      });
      document.getElementById("list").innerHTML = html;
    }

    function resetData() {
      scannedIDs.clear();
      document.getElementById("result").innerHTML = "";
      document.getElementById("list").innerHTML = "";
      document.getElementById("status").innerText = `üîÑ Reset complete. Loaded ${Object.keys(masterList).length} records`;
    }

    // load list on start
    loadMasterList();
  </script>
</body>
</html>
