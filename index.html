<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QR Code Scanner</title>
  <!-- PapaParse for CSV -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <!-- QR Scanner -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .container { display: flex; gap: 20px; align-items: flex-start; }
    #reader { width: 320px; height: 320px; border: 1px solid #ccc; }
    .controls { display: flex; flex-direction: column; gap: 10px; }
    button { padding: 10px; cursor: pointer; font-size: 14px; }
    #output { margin-top: 20px; flex: 1; }
    table { border-collapse: collapse; margin-top: 10px; width: 100%; }
    td, th { border: 1px solid #ccc; padding: 5px 10px; text-align: left; }
    h3 { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>QR Code Scanner</h1>

  <div class="container">
    <div id="reader"></div>
    <div class="controls">
      <button onclick="startScanner()">Start Scanner</button>
      <button onclick="showScanned()">Show Scanned</button>
      <button onclick="showPending()">Show Pending</button>
      <button onclick="resetData()">Reset</button>
    </div>
  </div>

  <div id="output"></div>

  <script>
    // ---------------- FIREBASE ----------------
    var firebaseConfig = {
      apiKey: "AIzaSyDnlTfbTFtFZzAEXNHaq2UqVLdTYVfrbW4",
      authDomain: "qr-attendance-79e24.firebaseapp.com",
      projectId: "qr-attendance-79e24",
      storageBucket: "qr-attendance-79e24.appspot.com",
      messagingSenderId: "255067675399",
      appId: "1:255067675399:web:501f5b0348a38999ed03a2",
      measurementId: "G-3B1Q8B6DDD",
      databaseURL: "https://qr-attendance-79e24-default-rtdb.asia-southeast1.firebasedatabase.app/"
    };
    firebase.initializeApp(firebaseConfig);
    var db = firebase.database();

    // ---------------- MASTER LIST ----------------
    let masterList = [];

    fetch("masterlist.csv")
      .then(response => response.text())
      .then(csvText => {
        Papa.parse(csvText, {
          header: true,
          complete: function(results) {
            masterList = results.data.map(row => ({
              ID: row["Row Labels"] ? row["Row Labels"].trim() : "",
              SLNO: row["SL NO"] || "",
              Books: row["Sum of BOOKS TALLY"] || "",
              Name: row["NAME"] || "",
              Contact: row["CONTACT"] || "",
              Age: row["AGE"] || "",
              Gender: row["M/F"] || "",
              Size: row["SIZE"] || "",
              Paid: row["Paid"] || "",
              Due: row["Due"] || "",
              Total: row["Total"] || "",
              Confirmation: row["Confirmation"] || ""
            })).filter(p => p.ID !== "");
            console.log("✅ Loaded master list:", masterList);
          }
        });
      });

    // ---------------- QR SCANNER ----------------
    let html5QrcodeScanner;

    function startScanner() {
      const qrCodeSuccessCallback = (decodedText) => {
        markScanned(decodedText);
      };

      html5QrcodeScanner = new Html5Qrcode("reader");
      Html5Qrcode.getCameras().then(devices => {
        if (devices && devices.length) {
          const cameraId = devices.length > 1 ? devices[devices.length - 1].id : devices[0].id;
          html5QrcodeScanner.start(
            cameraId,
            { fps: 10, qrbox: 250 },
            qrCodeSuccessCallback
          );
        }
      });
    }

    // ---------------- MARK SCANNED ----------------
    function markScanned(qrValue) {
      let id = qrValue.includes("/") ? qrValue.split("/").pop().trim() : qrValue.trim();

      const person = masterList.find(p => p.ID === id);
      if (!person) {
        alert("⚠️ ID not in master list: " + id);
        return;
      }

      db.ref("scanned/" + id).set({
        ...person,
        time: new Date().toLocaleString()
      });

      renderTable([person], "✅ Scanned");
    }

    // ---------------- SHOW SCANNED ----------------
    function showScanned() {
      db.ref("scanned").once("value").then(snapshot => {
        if (snapshot.exists()) {
          let data = Object.values(snapshot.val());
          renderTable(data, "📋 Scanned List");
        } else {
          document.getElementById("output").innerHTML = "<h3>📋 Scanned List</h3>No scans yet.";
        }
      }).catch(err => {
        console.error("Error fetching scanned:", err);
      });
    }

    // ---------------- SHOW PENDING ----------------
    function showPending() {
      db.ref("scanned").once("value").then(snapshot => {
        let scannedIDs = snapshot.exists() ? Object.keys(snapshot.val()) : [];
        let pending = masterList.filter(p => !scannedIDs.includes(p.ID));
        renderTable(pending, "⏳ Pending List");
      }).catch(err => {
        console.error("Error fetching pending:", err);
      });
    }

    // ---------------- RESET ----------------
    function resetData() {
      if (confirm("Are you sure you want to clear all data?")) {
        db.ref("scanned").remove();
        document.getElementById("output").innerText = "All scan data cleared.";
      }
    }

    // ---------------- RENDER TABLE ----------------
    function renderTable(list, title) {
      if (!list.length) {
        document.getElementById("output").innerHTML = `<h3>${title}</h3>No records found.`;
        return;
      }

      let headers = Object.keys(list[0]);
      let table = "<h3>" + title + "</h3><table><tr>" + headers.map(h => `<th>${h}</th>`).join("") + "</tr>";

      list.forEach(p => {
        table += "<tr>" + headers.map(h => `<td>${p[h] || ""}</td>`).join("") + "</tr>";
      });

      table += "</table>";
      document.getElementById("output").innerHTML = table;
    }
  </script>
</body>
</html>
