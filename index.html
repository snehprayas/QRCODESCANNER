<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QR Attendance System</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    #reader { width: 300px; margin: auto; }
    button { margin: 10px; padding: 10px 20px; }
    ul { text-align: left; display: inline-block; }
  </style>

  <!-- QR Scanner -->
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
  <!-- CSV Parser -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

  <!-- Firebase v12 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getDatabase, ref, set, remove, get, child } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

    // ðŸ”¹ Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDnlTfbTFtFZzAEXNHaq2UqVLdTYVfrbW4",
      authDomain: "qr-attendance-79e24.firebaseapp.com",
      databaseURL: "https://qr-attendance-79e24-default-rtdb.firebaseio.com",
      projectId: "qr-attendance-79e24",
      storageBucket: "qr-attendance-79e24.firebasestorage.app",
      messagingSenderId: "255067675399",
      appId: "1:255067675399:web:501f5b0348a38999ed03a2",
      measurementId: "G-3B1Q8B6DDD"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let masterList = []; // Loaded from CSV

    // âœ… Load master list from CSV
    function loadCSV() {
      Papa.parse("masterlist.csv", {
        download: true,
        header: true,
        complete: function(results) {
          masterList = results.data.filter(row => row.ID);
          console.log("Loaded master list:", masterList);
        }
      });
    }

    // âœ… QR Scanner
    function startScanner() {
      const html5QrCode = new Html5Qrcode("reader");
      Html5Qrcode.getCameras().then(cameras => {
        if (cameras.length) {
          html5QrCode.start(
            cameras[0].id,
            { fps: 10, qrbox: 250 },
            (decodedText) => {
              markScanned(decodedText.trim());
            }
          );
        }
      });
    }

    // âœ… Save scan in Firebase
    function markScanned(id) {
      const personRef = ref(db, "attendance/" + id);
      set(personRef, {
        scanned: true,
        time: new Date().toISOString()
      });
      showScanned();
    }

    // âœ… Reset all data
    function resetData() {
      remove(ref(db, "attendance"));
      document.getElementById("output").innerHTML = "<p>All data cleared.</p>";
    }

    // âœ… Show scanned list
    async function showScanned() {
      const snapshot = await get(child(ref(db), "attendance"));
      let data = snapshot.exists() ? snapshot.val() : {};
      let html = "<h3>Scanned âœ…</h3><ul>";
      for (let id in data) {
        if (data[id].scanned) {
          html += `<li>${id} at ${data[id].time}</li>`;
        }
      }
      html += "</ul>";
      document.getElementById("output").innerHTML = html;
    }

    // âœ… Show pending list
    async function showPending() {
      const snapshot = await get(child(ref(db), "attendance"));
      let data = snapshot.exists() ? snapshot.val() : {};

      let html = "<h3>Pending âŒ›</h3><ul>";
      masterList.forEach(row => {
        if (!(row.ID in data)) {
          html += `<li>${row.ID} - ${row.Name}</li>`;
        }
      });
      html += "</ul>";
      document.getElementById("output").innerHTML = html;
    }

    // Load master list when page loads
    window.onload = loadCSV;

    // Expose functions to buttons
    window.startScanner = startScanner;
    window.resetData = resetData;
    window.showScanned = showScanned;
    window.showPending = showPending;
  </script>
</head>
<body>
  <h1>QR Attendance System</h1>

  <div id="reader"></div>

  <div>
    <button onclick="startScanner()">â–¶ Start Scanner</button>
    <button onclick="showScanned()">âœ… Show Scanned</button>
    <button onclick="showPending()">âŒ› Show Pending</button>
    <button onclick="resetData()">ðŸ”„ Reset</button>
  </div>

  <div id="output"></div>
</body>
</html>
